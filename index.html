<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Spanish Flashcards">
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/gT7h4v4.png">

    <title>Spanish Flashcards</title>
    
    <!-- Scripts -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Styles -->
    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        /* Prevents flashing highlight on tap in mobile browsers */
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="overscroll-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Icon Components ---
        const BookIcon = () => <svg className="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>;
        const ChevronLeftIcon = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>;
        const ChevronRightIcon = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>;
        const RefreshIcon = () => <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>;
        const ShuffleIcon = () => <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>;
        const SpeakerIcon = () => <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>;
        const CheckIcon = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>;

        // --- DATA SETS ---
        const baseVerbSets = { "Essential Being & Having": [ { spanish: "ser", english: "to be (permanent)", conjugations: ["soy", "eres", "es", "somos", "sois", "son"] }, { spanish: "estar", english: "to be (temporary)", conjugations: ["estoy", "estás", "está", "estamos", "estáis", "están"] }, { spanish: "tener", english: "to have", conjugations: ["tengo", "tienes", "tiene", "tenemos", "tenéis", "tienen"] }, { spanish: "haber", english: "to have (auxiliary)", conjugations: ["he", "has", "ha", "hemos", "habéis", "han"] }, { spanish: "existir", english: "to exist", conjugations: ["existo", "existes", "existe", "existimos", "existís", "existen"] } ] };
        const baseNounSets = { "People & Family": [ { spanish: "familia", english: "family" }, { spanish: "madre", english: "mother" }, { spanish: "padre", english: "father" }, { spanish: "hijo", english: "son" }, { spanish: "hija", english: "daughter" } ] };
        const basePhraseSets = { "Greetings & Introductions": [ { spanish: "Hola, ¿cómo estás?", english: "Hello, how are you?" }, { spanish: "Me llamo...", english: "My name is..." }, { spanish: "¿Cómo te llamas?", english: "What's your name?" }, { spanish: "Mucho gusto", english: "Nice to meet you" } ] };
        const allDataSets = { ...baseVerbSets, ...baseNounSets, ...basePhraseSets };

        // --- Refactored Component: Flashcard ---
        const Flashcard = ({ card, isFlipped, mode }) => {
            const getDynamicFontSize = (text) => {
                if (!text) return 'sm:text-3xl text-2xl'; // Default size
                if (text.length > 30) return 'sm:text-xl text-lg';
                if (text.length > 20) return 'sm:text-2xl text-xl';
                return 'sm:text-3xl text-2xl';
            };
            
            if (!card) {
                return (
                    <div className="absolute inset-0 w-full h-full bg-white rounded-xl shadow-lg border-2 border-gray-200 flex flex-col items-center justify-center p-4 text-center">
                        <div className="text-lg text-gray-600 font-medium">You've mastered all cards in this set!</div>
                        <div className="text-sm text-gray-500 mt-2">Deselect a category or press Reset to study again.</div>
                    </div>
                );
            }

            const frontText = mode === 'spanish-to-english' ? card.spanish : card.english;
            const backText = mode === 'spanish-to-english' ? card.english : card.spanish;

            return (
                <div className={`absolute inset-0 w-full h-full transition-transform duration-500 transform-style-preserve-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                    <div className="absolute inset-0 w-full h-full bg-white rounded-xl shadow-lg border-2 border-indigo-100 backface-hidden flex flex-col items-center justify-center p-6">
                        <div className="text-xs uppercase tracking-wide text-gray-500 mb-2">{mode === 'spanish-to-english' ? 'Español' : 'English'}</div>
                        <div className={`font-bold text-gray-800 text-center ${getDynamicFontSize(frontText)}`}>{frontText}</div>
                        <div className="absolute bottom-4 text-xs text-gray-400 mt-4">Tap or swipe</div>
                    </div>
                    <div className="absolute inset-0 w-full h-full bg-indigo-50 rounded-xl shadow-lg border-2 border-indigo-200 backface-hidden rotate-y-180 flex flex-col items-center justify-center p-6">
                        <div className="text-xs uppercase tracking-wide text-indigo-600 mb-2">{mode === 'spanish-to-english' ? 'English' : 'Español'}</div>
                        <div className={`font-bold text-indigo-800 text-center mb-4 ${getDynamicFontSize(backText)}`}>{backText}</div>
                        {card.type === 'verb' && (
                            <div className="w-full max-w-xs">
                                <div className="text-xs text-indigo-600 text-center mb-2">Present Tense Conjugations</div>
                                <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                    {["yo", "tú", "él/ella", "nosotros", "vosotros", "ellos/ellas"].map((p, i) => <React.Fragment key={p}><div className="text-right text-indigo-700">{p}</div><div className="font-medium text-indigo-900">{card.conjugations[i]}</div></React.Fragment>)}
                                </div>
                            </div>
                        )}
                        <div className="absolute bottom-4 text-xs text-indigo-400">Tap or swipe</div>
                    </div>
                </div>
            );
        };

        // --- Refactored Component: DeckControls ---
        const DeckControls = ({ handlers, state }) => (
            <div className="flex justify-between items-center mb-6 mt-4">
                <button onClick={handlers.handlePrevious} disabled={state.deckSize < 2} className="flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm border disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition-colors text-sm"><ChevronLeftIcon />Previous</button>
                <div className="flex items-center gap-2">
                    <button onClick={handlers.resetDeckProgress} disabled={state.totalPotentialCards === 0} className="p-2 bg-white rounded-lg shadow-sm border hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Reset Progress for Selected Sets" aria-label="Reset deck progress"><RefreshIcon /></button>
                    <button onClick={handlers.handleSpeakerClick} disabled={!state.isCardPresent} className="p-2 bg-white rounded-lg shadow-sm border hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Play audio" aria-label="Play audio"><SpeakerIcon /></button>
                    <button onClick={handlers.handleToggleRemembered} disabled={!state.isCardPresent} className={`p-2 rounded-lg shadow-sm border transition-colors disabled:opacity-50 disabled:cursor-not-allowed ${state.isRemembered ? 'bg-green-500 text-white border-green-600 hover:bg-green-600' : 'bg-white text-gray-600 hover:bg-gray-50'}`} title={state.isRemembered ? "Mark as not known" : "Mark as known"}><CheckIcon /></button>
                </div>
                <button onClick={handlers.handleNext} disabled={state.deckSize < 2} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-indigo-700 transition-colors text-sm">Next<ChevronRightIcon /></button>
            </div>
        );

        // --- Refactored Component: CategoryTabs ---
        const CategoryTabs = ({ activeTab, setActiveTab, activeSets, handleSetToggle }) => {
             const CheckboxGrid = ({ sets, type, onToggleAll }) => (
                <div className="mb-6 bg-white/50 p-4 rounded-lg border border-gray-200 shadow-sm">
                    <div className="flex justify-between items-center mb-3">
                        <label className="text-sm font-medium text-gray-800">Choose {type} Sets:</label>
                        <div className="flex gap-2">
                            <button onClick={() => onToggleAll(sets, true)} className="text-xs font-medium text-indigo-600 hover:text-indigo-800">Select All</button>
                            <button onClick={() => onToggleAll(sets, false)} className="text-xs font-medium text-indigo-600 hover:text-indigo-800">Deselect All</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-1 gap-x-4 gap-y-2">
                        {Object.keys(sets).map((setName) => (
                            <label key={setName} className="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-indigo-100/50">
                                <input type="checkbox" checked={!!activeSets[setName]} onChange={() => handleSetToggle(setName)} className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"/>
                                <span className="text-sm text-gray-700 select-none">{setName}</span>
                            </label>
                        ))}
                    </div>
                </div>
            );
            return (
                <div>
                    <div className="border-b border-gray-200"><nav className="-mb-px flex justify-center gap-6" aria-label="Tabs">
                        <button onClick={() => setActiveTab('verbs')} className={`${activeTab === 'verbs' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'} py-4 px-1 border-b-2 font-medium text-sm`}>Verbs</button>
                        <button onClick={() => setActiveTab('nouns')} className={`${activeTab === 'nouns' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'} py-4 px-1 border-b-2 font-medium text-sm`}>Nouns</button>
                        <button onClick={() => setActiveTab('phrases')} className={`${activeTab === 'phrases' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'} py-4 px-1 border-b-2 font-medium text-sm`}>Phrases</button>
                    </nav></div>
                    <div className="pt-5">
                        {activeTab === 'verbs' && <CheckboxGrid sets={baseVerbSets} type="Verb" onToggleAll={(sets, shouldSelect) => Object.keys(sets).forEach(name => handleSetToggle(name, shouldSelect))} />}
                        {activeTab === 'nouns' && <CheckboxGrid sets={baseNounSets} type="Noun" onToggleAll={(sets, shouldSelect) => Object.keys(sets).forEach(name => handleSetToggle(name, shouldSelect))} />}
                        {activeTab === 'phrases' && <CheckboxGrid sets={basePhraseSets} type="Phrase" onToggleAll={(sets, shouldSelect) => Object.keys(sets).forEach(name => handleSetToggle(name, shouldSelect))} />}
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const SpanishFlashcards = () => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [mode, setMode] = useState('spanish-to-english');
            const [activeTab, setActiveTab] = useState('verbs');
            const [activeSets, setActiveSets] = useState({ "Essential Being & Having": true });
            const [shuffledCards, setShuffledCards] = useState([]);
            const [voices, setVoices] = useState([]);
            const [touchState, setTouchState] = useState({ start: null, end: null });

            const [rememberedCards, setRememberedCards] = useState(() => {
                try {
                    const saved = localStorage.getItem('rememberedSpanishCards');
                    return saved ? new Set(JSON.parse(saved)) : new Set();
                } catch { return new Set(); }
            });

            useEffect(() => {
                const handler = setTimeout(() => {
                    localStorage.setItem('rememberedSpanishCards', JSON.stringify(Array.from(rememberedCards)));
                }, 500);
                return () => clearTimeout(handler);
            }, [rememberedCards]);
            
            useEffect(() => {
                const loadVoices = () => setVoices(window.speechSynthesis.getVoices());
                window.speechSynthesis.onvoiceschanged = loadVoices; loadVoices();
            }, []);

            const totalPotentialCards = useMemo(() => {
                const getSetType = (setName) => {
                    if (baseVerbSets[setName]) return 'verb';
                    if (baseNounSets[setName]) return 'noun';
                    if (basePhraseSets[setName]) return 'phrase';
                };
                return Object.keys(activeSets).flatMap(setName => 
                    (activeSets[setName] && allDataSets[setName]) 
                        ? allDataSets[setName].map(card => ({ ...card, type: getSetType(setName) })) 
                        : []
                ).filter((card, index, self) => index === self.findIndex(c => c.spanish === card.spanish));
            }, [activeSets]);

            useEffect(() => {
                const cardsToStudy = totalPotentialCards.filter(card => !rememberedCards.has(card.spanish));
                setShuffledCards(shuffle(cardsToStudy));
                setCurrentIndex(0);
                setIsFlipped(false);
            }, [totalPotentialCards, rememberedCards]);

            const shuffle = (array) => {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            };

            const speakText = useCallback((text) => {
                if (!('speechSynthesis' in window)) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 0.8;
                const spanishVoice = voices.find(v => v.lang === 'es-ES') || voices.find(v => v.lang.startsWith('es-'));
                if (spanishVoice) utterance.voice = spanishVoice;
                setTimeout(() => window.speechSynthesis.speak(utterance), 100);
            }, [voices]);

            const handleNext = () => {
                if (shuffledCards.length === 0) return;
                setCurrentIndex(i => (i + 1) % shuffledCards.length);
                setIsFlipped(false);
            };
            const handlePrevious = () => {
                if (shuffledCards.length === 0) return;
                setCurrentIndex(i => (i - 1 + shuffledCards.length) % shuffledCards.length);
                setIsFlipped(false);
            };
            const handleFlip = () => { if (shuffledCards.length > 0) setIsFlipped(f => !f); };
            const handleSpeakerClick = () => { if (shuffledCards[currentIndex]) speakText(shuffledCards[currentIndex].spanish); };
            const handleShuffle = () => { setShuffledCards(shuffle(shuffledCards)); setCurrentIndex(0); setIsFlipped(false); };
            
            const handleToggleRemembered = () => {
                const currentCard = shuffledCards[currentIndex];
                if (!currentCard) return;
                setRememberedCards(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(currentCard.spanish)) newSet.delete(currentCard.spanish);
                    else newSet.add(currentCard.spanish);
                    return newSet;
                });
            };

            const resetDeckProgress = () => {
                const cardsToReset = totalPotentialCards.map(card => card.spanish);
                setRememberedCards(prev => {
                    const newSet = new Set(prev);
                    cardsToReset.forEach(id => newSet.delete(id));
                    return newSet;
                });
            };

            const handleSetToggle = (setName, forceState) => {
                const isCurrentlyActive = !!activeSets[setName];
                const shouldBeActive = typeof forceState === 'boolean' ? forceState : !isCurrentlyActive;

                if (isCurrentlyActive === shouldBeActive) return;

                if (!shouldBeActive) {
                    const cardsInSet = allDataSets[setName].map(c => c.spanish);
                    setRememberedCards(prev => {
                        const newSet = new Set(prev);
                        cardsInSet.forEach(id => newSet.delete(id));
                        return newSet;
                    });
                }
                setActiveSets(prev => ({ ...prev, [setName]: shouldBeActive }));
            };
            
            const onTouchStart = (e) => setTouchState({ start: e.targetTouches[0].clientX, end: null });
            const onTouchMove = (e) => setTouchState(s => ({ ...s, end: e.targetTouches[0].clientX }));
            const onTouchEnd = (e) => {
                const { start, end } = touchState;
                if (start === null) return;

                const distance = end ? Math.abs(start - end) : 0;
                const minSwipeDistance = 50;
                const maxTapDistance = 10;

                if (distance > minSwipeDistance) {
                    if (start - end > 0) handleNext(); else handlePrevious();
                } else if (distance < maxTapDistance) {
                    e.preventDefault();
                    handleFlip();
                }
                setTouchState({ start: null, end: null });
            };

            const currentCard = shuffledCards[currentIndex];
            const rememberedCount = totalPotentialCards.length - shuffledCards.length;
            const progress = totalPotentialCards.length > 0 ? (rememberedCount / totalPotentialCards.length) * 100 : 0;
            const isRemembered = currentCard && rememberedCards.has(currentCard.spanish);

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 flex flex-col">
                    <div className="max-w-md mx-auto w-full flex flex-col flex-grow">
                        <header className="text-center mb-6">
                            <div className="flex items-center justify-center gap-2 mb-2"><BookIcon /><h1 className="text-2xl font-bold text-gray-800">Spanish Flashcards</h1></div>
                        </header>

                        <div className="mb-4">
                            <div className="flex justify-between text-sm text-gray-600 mb-1"><span>Mastery Progress</span><span>{rememberedCount}/{totalPotentialCards.length} ({progress.toFixed(1)}%)</span></div>
                            <div className="w-full bg-gray-200 rounded-full h-2"><div className="bg-green-500 h-2 rounded-full" style={{ width: `${progress}%` }}></div></div>
                        </div>
                        <div className="flex justify-between items-center mb-6">
                            <button onClick={() => setMode(m => m === 'spanish-to-english' ? 'english-to-spanish' : 'spanish-to-english')} className="px-3 py-2 bg-white rounded-lg shadow-sm border text-sm font-medium text-gray-700 hover:bg-gray-50">{mode === 'spanish-to-english' ? 'ES → EN' : 'EN → ES'}</button>
                            <div className="text-sm font-medium text-gray-600">{shuffledCards.length > 0 ? `Card ${currentIndex + 1} / ${shuffledCards.length}` : 'Deck Empty'}</div>
                            <button onClick={handleShuffle} disabled={shuffledCards.length < 2} className="p-2 bg-white rounded-lg shadow-sm border hover:bg-gray-50 disabled:opacity-50"><ShuffleIcon /></button>
                        </div>

                        <div className="relative w-full h-80 cursor-pointer perspective-1000" onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd} onClick={handleFlip}>
                            <Flashcard card={currentCard} isFlipped={isFlipped} mode={mode} />
                        </div>
                        
                        <DeckControls 
                            handlers={{ handlePrevious, resetDeckProgress, handleSpeakerClick, handleToggleRemembered, handleNext }}
                            state={{ deckSize: shuffledCards.length, totalPotentialCards: totalPotentialCards.length, isCardPresent: !!currentCard, isRemembered }}
                        />

                        <div className="flex-grow"></div>

                        <CategoryTabs activeTab={activeTab} setActiveTab={setActiveTab} activeSets={activeSets} handleSetToggle={handleSetToggle} />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SpanishFlashcards />);
    </script>
</body>
</html>
